<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refund Management - LMS Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="/ui/lms">
                <img src="/static/logo.svg" alt="LMS Logo" class="me-2" style="height: 40px; width: auto;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
                <span style="display: none; font-size: 1.5rem; font-weight: bold;">ðŸ“š</span>
                <span class="ms-2">LMS Portal</span>
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/ui/lms/admin/analytics">Analytics</a>
                <a class="nav-link" href="/ui/lms/admin/coupons">Coupons</a>
                <a class="nav-link active" href="/ui/lms/admin/refunds">Refunds</a>
                <a class="nav-link" href="/ui/lms">Home</a>
                <a class="nav-link" href="#" onclick="logout(); return false;">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <h1 class="mb-4">Refund Management</h1>

        <ul class="nav nav-tabs mb-4" id="refundTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button">Pending</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button">All Refunds</button>
            </li>
        </ul>

        <div class="tab-content" id="refundTabsContent">
            <!-- Pending Refunds -->
            <div class="tab-pane fade show active" id="pending" role="tabpanel">
                <div id="pendingRefunds" class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Course</th>
                                <th>Amount</th>
                                <th>Reason</th>
                                <th>Requested Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pendingRefundsBody">
                            <tr><td colspan="6" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- All Refunds -->
            <div class="tab-pane fade" id="all" role="tabpanel">
                <div id="allRefunds" class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Course</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Requested Date</th>
                                <th>Processed Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="allRefundsBody">
                            <tr><td colspan="7" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Approve/Reject Modal -->
    <div class="modal fade" id="refundActionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="refundActionModalTitle">Process Refund</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="refundActionForm">
                        <input type="hidden" id="refundActionId">
                        <input type="hidden" id="refundActionType">
                        <div class="mb-3">
                            <label class="form-label">Admin Notes</label>
                            <textarea class="form-control" id="refundAdminNotes" rows="4"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="refundActionButton" onclick="processRefundAction()">Process</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/ui/auth';
        }

        async function loadPendingRefunds() {
            try {
                const response = await fetch('/api/lms/refunds/pending', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (response.ok) {
                    const refunds = await response.json();
                    displayPendingRefunds(refunds);
                }
            } catch (error) {
                console.error('Error loading pending refunds:', error);
            }
        }

        async function loadAllRefunds() {
            try {
                const response = await fetch('/api/lms/refunds/all', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (response.ok) {
                    const refunds = await response.json();
                    displayAllRefunds(refunds);
                }
            } catch (error) {
                console.error('Error loading all refunds:', error);
            }
        }

        function displayPendingRefunds(refunds) {
            const tbody = document.getElementById('pendingRefundsBody');
            
            if (!refunds || refunds.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No pending refunds</td></tr>';
                return;
            }

            tbody.innerHTML = refunds.map(refund => `
                <tr>
                    <td>${escapeHtml(refund.student?.name || refund.student?.email || 'Unknown')}</td>
                    <td>${escapeHtml(refund.course?.title || 'Unknown')}</td>
                    <td>â‚¹${parseFloat(refund.amount || 0).toFixed(2)}</td>
                    <td>${escapeHtml(refund.reason || 'N/A')}</td>
                    <td>${new Date(refund.requestedAt).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="showRefundActionModal(${refund.id}, 'approve')">Approve</button>
                        <button class="btn btn-sm btn-danger" onclick="showRefundActionModal(${refund.id}, 'reject')">Reject</button>
                    </td>
                </tr>
            `).join('');
        }

        function displayAllRefunds(refunds) {
            const tbody = document.getElementById('allRefundsBody');
            
            if (!refunds || refunds.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No refunds found</td></tr>';
                return;
            }

            tbody.innerHTML = refunds.map(refund => `
                <tr>
                    <td>${escapeHtml(refund.student?.name || refund.student?.email || 'Unknown')}</td>
                    <td>${escapeHtml(refund.course?.title || 'Unknown')}</td>
                    <td>â‚¹${parseFloat(refund.amount || 0).toFixed(2)}</td>
                    <td><span class="badge bg-${getStatusColor(refund.status)}">${escapeHtml(refund.status || 'PENDING')}</span></td>
                    <td>${new Date(refund.requestedAt).toLocaleDateString()}</td>
                    <td>${refund.processedAt ? new Date(refund.processedAt).toLocaleDateString() : '-'}</td>
                    <td>
                        ${refund.adminNotes ? `<small class="text-muted">${escapeHtml(refund.adminNotes)}</small>` : '-'}
                    </td>
                </tr>
            `).join('');
        }

        function getStatusColor(status) {
            switch(status) {
                case 'APPROVED':
                case 'PROCESSED':
                    return 'success';
                case 'REJECTED':
                case 'FAILED':
                    return 'danger';
                case 'PENDING':
                    return 'warning';
                default:
                    return 'secondary';
            }
        }

        function showRefundActionModal(refundId, actionType) {
            document.getElementById('refundActionId').value = refundId;
            document.getElementById('refundActionType').value = actionType;
            document.getElementById('refundAdminNotes').value = '';
            document.getElementById('refundActionModalTitle').textContent = actionType === 'approve' ? 'Approve Refund' : 'Reject Refund';
            document.getElementById('refundActionButton').textContent = actionType === 'approve' ? 'Approve' : 'Reject';
            document.getElementById('refundActionButton').className = actionType === 'approve' ? 'btn btn-success' : 'btn btn-danger';
            new bootstrap.Modal(document.getElementById('refundActionModal')).show();
        }

        async function processRefundAction() {
            const refundId = document.getElementById('refundActionId').value;
            const actionType = document.getElementById('refundActionType').value;
            const adminNotes = document.getElementById('refundAdminNotes').value.trim();

            try {
                const url = actionType === 'approve' 
                    ? `/api/lms/refunds/${refundId}/approve`
                    : `/api/lms/refunds/${refundId}/reject`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ adminNotes: adminNotes })
                });

                const data = await response.json();

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('refundActionModal')).hide();
                    alert(`Refund ${actionType === 'approve' ? 'approved' : 'rejected'} successfully`);
                    loadPendingRefunds();
                    loadAllRefunds();
                } else {
                    alert(data.error || `Failed to ${actionType} refund`);
                }
            } catch (error) {
                console.error('Error processing refund:', error);
                alert(`Failed to ${actionType} refund`);
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/ui/auth';
        }

        // Load data on page load
        loadPendingRefunds();
        loadAllRefunds();
    </script>
</body>
</html>

