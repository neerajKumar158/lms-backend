<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browse Courses - LMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="/ui/lms">
                <img src="/static/logo.svg" alt="LMS Logo" class="me-2" style="height: 40px; width: auto;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
                <span style="display: none; font-size: 1.5rem; font-weight: bold;">üìö</span>
                <span class="ms-2">LMS Portal</span>
            </a>
            <div class="navbar-nav ms-auto d-flex flex-row">
                <a class="nav-link me-3" href="/ui/lms">Home</a>
                <a class="nav-link" href="#" onclick="logout(); return false;">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <h1 class="mb-4">Browse All Courses</h1>
        
        <div class="row mb-4">
            <div class="col-md-6">
                <input type="text" class="form-control" id="searchInput" placeholder="Search courses...">
            </div>
            <div class="col-md-6">
                <button class="btn btn-primary" onclick="searchCourses()">Search</button>
                <a href="/ui/lms/courses" class="btn btn-secondary">Show All</a>
            </div>
        </div>

        <div id="coursesGrid" class="row">
            <div class="col-12 text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        async function loadCourses() {
            try {
                const response = await fetch('/api/lms/courses');
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
                const courses = await response.json();
                if (!Array.isArray(courses)) {
                    throw new Error('Invalid response format');
                }
                displayCourses(courses);
            } catch (error) {
                console.error('Error loading courses:', error);
                document.getElementById('coursesGrid').innerHTML = 
                    `<div class="col-12">
                        <div class="alert alert-danger">
                            <strong>Error loading courses:</strong> ${error.message || 'Unknown error'}
                            <br><button class="btn btn-sm btn-primary mt-2" onclick="loadCourses()">Retry</button>
                        </div>
                    </div>`;
            }
        }

        async function searchCourses() {
            const keyword = document.getElementById('searchInput').value;
            if (!keyword.trim()) {
                loadCourses();
                return;
            }
            
            try {
                const response = await fetch(`/api/lms/courses/search?keyword=${encodeURIComponent(keyword)}`);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
                const courses = await response.json();
                if (!Array.isArray(courses)) {
                    throw new Error('Invalid response format');
                }
                displayCourses(courses);
            } catch (error) {
                console.error('Error searching courses:', error);
                document.getElementById('coursesGrid').innerHTML = 
                    `<div class="col-12">
                        <div class="alert alert-danger">
                            <strong>Error searching courses:</strong> ${error.message || 'Unknown error'}
                        </div>
                    </div>`;
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function displayCourses(courses) {
            const grid = document.getElementById('coursesGrid');
            
            if (!courses || courses.length === 0) {
                grid.innerHTML = '<div class="col-12 text-center"><p>No courses found.</p></div>';
                return;
            }
            
            const token = localStorage.getItem('token');
            const wishlistStatuses = {};
            
            // Check wishlist status for all courses if logged in
            if (token) {
                await Promise.all(courses.map(async (course) => {
                    try {
                        const response = await fetch(`/api/lms/wishlist/course/${course.id}/check`, {
                            headers: { 'Authorization': 'Bearer ' + token }
                        });
                        if (response.ok) {
                            const data = await response.json();
                            wishlistStatuses[course.id] = data.inWishlist;
                        }
                    } catch (error) {
                        console.error('Error checking wishlist:', error);
                    }
                }));
            }
            
            grid.innerHTML = courses.map(course => {
                const price = course.price || 0;
                const isFree = price === 0 || price === '0.00' || parseFloat(price) === 0;
                const title = course.title || 'Untitled Course';
                const description = course.description ? course.description.substring(0, 150) + '...' : 'No description available';
                const level = course.level || 'N/A';
                const isInWishlist = wishlistStatuses[course.id] || false;
                const wishlistButton = token ? `
                    <button class="btn btn-sm ${isInWishlist ? 'btn-danger' : 'btn-outline-danger'} mb-2" onclick="toggleWishlist(${course.id}, this)">
                        ${isInWishlist ? '‚ù§Ô∏è Remove' : '‚ô° Add to Wishlist'}
                    </button>
                ` : '';
                
                return `
                    <div class="col-md-4 mb-4">
                        <div class="card h-100 position-relative">
                            ${course.thumbnailUrl ? 
                                `<img src="${escapeHtml(course.thumbnailUrl)}" class="card-img-top" style="height: 200px; object-fit: cover;">` :
                                `<div class="card-img-top bg-secondary d-flex align-items-center justify-content-center" style="height: 200px;">
                                    <span class="text-white">No Image</span>
                                </div>`
                            }
                            <div class="card-body">
                                <h5 class="card-title">${escapeHtml(title)}</h5>
                                <p class="card-text">${escapeHtml(description)}</p>
                                <p class="text-muted">Level: ${level}</p>
                                <p class="${isFree ? 'text-success' : 'text-primary'} fw-bold">
                                    ${isFree ? 'FREE' : '‚Çπ' + price}
                                </p>
                                ${wishlistButton}
                                <a href="/ui/lms/courses/${course.id}" class="btn btn-primary w-100">View Details</a>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function toggleWishlist(courseId, button) {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/ui/auth';
                return;
            }
            
            const isInWishlist = button.textContent.includes('Remove');
            const url = `/api/lms/wishlist/course/${courseId}`;
            const method = isInWishlist ? 'DELETE' : 'POST';
            
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                if (response.ok) {
                    if (isInWishlist) {
                        button.textContent = '‚ô° Add to Wishlist';
                        button.classList.remove('btn-danger');
                        button.classList.add('btn-outline-danger');
                    } else {
                        button.textContent = '‚ù§Ô∏è Remove';
                        button.classList.remove('btn-outline-danger');
                        button.classList.add('btn-danger');
                    }
                } else {
                    const data = await response.json();
                    alert(data.error || 'Failed to update wishlist');
                }
            } catch (error) {
                console.error('Error toggling wishlist:', error);
                alert('Failed to update wishlist');
            }
        }

        async function checkUserAndShowNav() {
            const token = localStorage.getItem('token');
            if (token) {
                try {
                    const response = await fetch('/api/profile', {
                        headers: { 'Authorization': 'Bearer ' + token }
                    });
                    if (response.ok) {
                        const user = await response.json();
                        if (user.userType === 'STUDENT') {
                            document.getElementById('recommendationsNav').style.display = 'block';
                            document.getElementById('wishlistNav').style.display = 'block';
                        }
                    }
                } catch (error) {
                    console.error('Error checking user:', error);
                }
            }
        }

        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchCourses();
            }
        });

        checkUserAndShowNav();
        loadCourses();
    </script>
</body>
</html>

