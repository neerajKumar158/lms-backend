<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Your Profile - LMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            border-bottom: 3px solid #dee2e6;
            color: #6c757d;
        }
        .step.active {
            border-bottom-color: #0d6efd;
            color: #0d6efd;
            font-weight: bold;
        }
        .step.completed {
            border-bottom-color: #198754;
            color: #198754;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="/ui/lms">
                <img src="/static/logo.svg" alt="LMS Logo" class="me-2" style="height: 40px; width: auto;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
                <span style="display: none; font-size: 1.5rem; font-weight: bold;">ðŸ“š</span>
                <span class="ms-2">LMS Portal</span>
            </a>
            <div class="navbar-nav ms-auto d-flex flex-row">
                <a class="nav-link me-3" href="/ui/lms">Home</a>
                <a class="nav-link" href="#" onclick="logout(); return false;">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <h2 class="card-title text-center mb-4">Complete Your Profile</h2>
                        
                        <!-- Step Indicator -->
                        <div class="step-indicator">
                            <div class="step active" id="step1-indicator">
                                <div>1</div>
                                <small>Basic Info</small>
                            </div>
                            <div class="step" id="step2-indicator">
                                <div>2</div>
                                <small>Additional Details</small>
                            </div>
                            <div class="step" id="step3-indicator">
                                <div>3</div>
                                <small>Review</small>
                            </div>
                        </div>

                        <!-- Step 1: Basic Information -->
                        <div id="step1" class="step-content">
                            <h4 class="mb-3">Basic Information</h4>
                            <form id="step1Form">
                                <div class="mb-3">
                                    <label class="form-label">Full Name *</label>
                                    <input type="text" class="form-control" name="name" id="name" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Phone Number *</label>
                                    <input type="tel" class="form-control" name="phone" id="phone" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Address</label>
                                    <input type="text" class="form-control" name="address" id="address">
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">City</label>
                                        <input type="text" class="form-control" name="city" id="city">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Country</label>
                                        <input type="text" class="form-control" name="country" id="country">
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Next</button>
                            </form>
                        </div>

                        <!-- Step 2: Additional Details -->
                        <div id="step2" class="step-content" style="display: none;">
                            <h4 class="mb-3">Additional Details</h4>
                            <form id="step2Form">
                                <div class="mb-3">
                                    <label class="form-label">Bio / About Me</label>
                                    <textarea class="form-control" name="bio" id="bio" rows="4" 
                                              placeholder="Tell us about yourself..."></textarea>
                                </div>
                                <div id="teacherFields" style="display: none;">
                                    <div class="mb-3">
                                        <label class="form-label">Qualifications</label>
                                        <textarea class="form-control" name="qualifications" id="qualifications" rows="3"
                                                  placeholder="Your educational qualifications, certifications, etc."></textarea>
                                    </div>
                                </div>
                                <div id="organizationFields" style="display: none;">
                                    <div class="mb-3">
                                        <label class="form-label">Organization Name</label>
                                        <input type="text" class="form-control" name="orgName" id="orgName">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Organization Description</label>
                                        <textarea class="form-control" name="orgDescription" id="orgDescription" rows="3"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Website</label>
                                        <input type="url" class="form-control" name="website" id="website">
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-secondary" onclick="goToStep(1)">Back</button>
                                    <button type="submit" class="btn btn-primary">Next</button>
                                </div>
                            </form>
                        </div>

                        <!-- Step 3: Review -->
                        <div id="step3" class="step-content" style="display: none;">
                            <h4 class="mb-3">Review Your Information</h4>
                            <div id="reviewContent"></div>
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-secondary" onclick="goToStep(2)">Back</button>
                                <button type="button" class="btn btn-success" onclick="submitProfile()">Complete Profile</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentStep = 1;
        let profileData = {};
        let userType = null;

        // Load user info
        async function loadUserInfo() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/ui/auth';
                return;
            }

            try {
                const response = await fetch('/api/profile', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    userType = user.userType;
                    
                    // Pre-fill form if data exists
                    if (user.name) document.getElementById('name').value = user.name;
                    if (user.phone) document.getElementById('phone').value = user.phone;
                    
                    // Show/hide fields based on user type
                    if (userType === 'TEACHER') {
                        document.getElementById('teacherFields').style.display = 'block';
                        if (user.qualifications) document.getElementById('qualifications').value = user.qualifications;
                    } else if (userType === 'ORGANIZATION') {
                        document.getElementById('organizationFields').style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }

        // Step navigation
        function goToStep(step) {
            document.getElementById(`step${currentStep}`).style.display = 'none';
            document.getElementById(`step${currentStep}-indicator`).classList.remove('active');
            
            currentStep = step;
            document.getElementById(`step${currentStep}`).style.display = 'block';
            document.getElementById(`step${currentStep}-indicator`).classList.add('active');
            
            // Mark previous steps as completed
            for (let i = 1; i < step; i++) {
                document.getElementById(`step${i}-indicator`).classList.add('completed');
            }
        }

        // Step 1 form submission
        document.getElementById('step1Form').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            profileData.step1 = Object.fromEntries(formData);
            goToStep(2);
        });

        // Step 2 form submission
        document.getElementById('step2Form').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            profileData.step2 = Object.fromEntries(formData);
            displayReview();
            goToStep(3);
        });

        // Display review
        function displayReview() {
            const review = document.getElementById('reviewContent');
            review.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <h5>Basic Information</h5>
                        <p><strong>Name:</strong> ${profileData.step1.name || 'N/A'}</p>
                        <p><strong>Phone:</strong> ${profileData.step1.phone || 'N/A'}</p>
                        <p><strong>Address:</strong> ${profileData.step1.address || 'N/A'}</p>
                        <p><strong>City:</strong> ${profileData.step1.city || 'N/A'}</p>
                        <p><strong>Country:</strong> ${profileData.step1.country || 'N/A'}</p>
                        
                        <h5 class="mt-3">Additional Details</h5>
                        <p><strong>Bio:</strong> ${profileData.step2.bio || 'N/A'}</p>
                        ${userType === 'TEACHER' ? `<p><strong>Qualifications:</strong> ${profileData.step2.qualifications || 'N/A'}</p>` : ''}
                        ${userType === 'ORGANIZATION' ? `
                            <p><strong>Organization Name:</strong> ${profileData.step2.orgName || 'N/A'}</p>
                            <p><strong>Description:</strong> ${profileData.step2.orgDescription || 'N/A'}</p>
                            <p><strong>Website:</strong> ${profileData.step2.website || 'N/A'}</p>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Submit profile
        async function submitProfile() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/ui/auth';
                return;
            }

            try {
                const profileRequest = {
                    name: profileData.step1.name,
                    phone: profileData.step1.phone,
                    address: profileData.step1.address,
                    city: profileData.step1.city,
                    country: profileData.step1.country,
                    bio: profileData.step2.bio,
                    qualifications: profileData.step2.qualifications
                };

                const response = await fetch('/api/profile', {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(profileRequest)
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('Profile completed successfully!');
                    // Redirect based on user type
                    if (userType === 'STUDENT') {
                        window.location.href = '/ui/lms/student/dashboard';
                    } else if (userType === 'TEACHER') {
                        window.location.href = '/ui/lms/teacher/dashboard';
                    } else if (userType === 'ORGANIZATION') {
                        window.location.href = '/ui/lms/organization/dashboard';
                    } else {
                        window.location.href = '/ui/lms';
                    }
                } else {
                    alert('Error: ' + (result.error || 'Failed to complete profile'));
                }
            } catch (error) {
                console.error('Error submitting profile:', error);
                alert('Failed to complete profile. Please try again.');
            }
        }

        // Initialize
        loadUserInfo();
    </script>
</body>
</html>



