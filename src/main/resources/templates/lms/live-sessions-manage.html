<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Live Sessions - LMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        .session-card {
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 15px;
        }
        .session-card.scheduled {
            border-left: 4px solid #007bff;
        }
        .session-card.ongoing {
            border-left: 4px solid #28a745;
            background: #f0fff4;
        }
        .session-card.completed {
            border-left: 4px solid #6c757d;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/ui/lms">LMS Portal</a>
            <div class="navbar-nav ms-auto d-flex flex-row">
                <a class="nav-link me-3" href="/ui/lms">Home</a>
                <a class="nav-link" href="#" onclick="logout(); return false;">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-camera-video"></i> Manage Live Sessions</h2>
            <button class="btn btn-primary" onclick="showCreateSessionModal()">
                <i class="bi bi-plus-circle"></i> Create New Session
            </button>
        </div>

        <div class="mb-3">
            <select id="courseFilter" class="form-select" onchange="loadSessions()">
                <option value="">All Sessions</option>
            </select>
        </div>

        <div id="sessionsList"></div>
    </div>

    <!-- Create Session Modal -->
    <div class="modal fade" id="createSessionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create Live Session</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createSessionForm">
                        <div class="mb-3">
                            <label class="form-label">Course (Optional)</label>
                            <select class="form-select" id="sessionCourseSelect" name="courseId">
                                <option value="">-- Standalone Session (No Course) --</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Session Title *</label>
                            <input type="text" class="form-control" name="title" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Scheduled Date & Time *</label>
                                <input type="datetime-local" class="form-control" name="scheduledDateTime" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Duration (minutes)</label>
                                <input type="number" class="form-control" name="durationMinutes" min="15" value="60">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Max Participants</label>
                            <input type="number" class="form-control" name="maxParticipants" min="2" value="50">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createSession()">Create Session</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const token = localStorage.getItem('token');
        const urlParams = new URLSearchParams(window.location.search);
        const courseId = urlParams.get('courseId');

        if (!token) {
            window.location.href = '/ui/auth';
        }

        async function loadCourses() {
            try {
                const response = await fetch('/api/lms/courses/my-courses', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (response.ok) {
                    const courses = await response.json();
                    const select = document.getElementById('courseFilter');
                    const sessionSelect = document.getElementById('sessionCourseSelect');
                    
                    courses.forEach(course => {
                        const option1 = document.createElement('option');
                        option1.value = course.id;
                        option1.textContent = course.title;
                        if (courseId && course.id == courseId) {
                            option1.selected = true;
                        }
                        select.appendChild(option1);
                        
                        const option2 = document.createElement('option');
                        option2.value = course.id;
                        option2.textContent = course.title;
                        sessionSelect.appendChild(option2);
                    });
                }
            } catch (error) {
                console.error('Error loading courses:', error);
            }
        }

        async function loadSessions() {
            const selectedCourseId = document.getElementById('courseFilter').value || courseId;
            
            try {
                let url = '/api/lms/live-sessions/instructor';
                if (selectedCourseId) {
                    url = `/api/lms/live-sessions/course/${selectedCourseId}`;
                }
                
                console.log('Loading sessions from:', url); // Debug log
                
                const response = await fetch(url, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                console.log('Response status:', response.status); // Debug log
                
                if (response.ok) {
                    const sessions = await response.json();
                    console.log('Loaded sessions:', sessions); // Debug log
                    console.log('Number of sessions:', sessions ? sessions.length : 0); // Debug log
                    
                    if (!sessions || sessions.length === 0) {
                        console.warn('No sessions returned from API');
                    }
                    
                    displaySessions(sessions);
                } else {
                    const errorText = await response.text();
                    console.error('Failed to load sessions:', response.status, errorText);
                    let errorMessage = 'Failed to load sessions. Please try again.';
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.error || errorMessage;
                    } catch (e) {
                        errorMessage = errorText || errorMessage;
                    }
                    document.getElementById('sessionsList').innerHTML = 
                        '<div class="alert alert-warning">' + errorMessage + '</div>';
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
                document.getElementById('sessionsList').innerHTML = 
                    '<div class="alert alert-danger">Error loading sessions: ' + error.message + '</div>';
            }
        }

        function displaySessions(sessions) {
            console.log('Displaying sessions:', sessions); // Debug log
            
            if (!sessions || sessions.length === 0) {
                document.getElementById('sessionsList').innerHTML = 
                    '<div class="alert alert-info">No live sessions yet. Create your first session!</div>';
                return;
            }

            // Filter out null/invalid sessions
            const validSessions = sessions.filter(s => s && s.id);
            console.log('Valid sessions after filtering:', validSessions.length);
            
            if (validSessions.length === 0) {
                document.getElementById('sessionsList').innerHTML = 
                    '<div class="alert alert-warning">No valid sessions found in the response.</div>';
                return;
            }

            // Sort sessions: ONGOING first, then SCHEDULED, then COMPLETED
            validSessions.sort((a, b) => {
                if (a.status === 'ONGOING' && b.status !== 'ONGOING') return -1;
                if (a.status !== 'ONGOING' && b.status === 'ONGOING') return 1;
                if (a.status === 'SCHEDULED' && b.status === 'COMPLETED') return -1;
                if (a.status === 'COMPLETED' && b.status === 'SCHEDULED') return 1;
                if (a.scheduledDateTime && b.scheduledDateTime) {
                    return new Date(a.scheduledDateTime) - new Date(b.scheduledDateTime);
                }
                return 0;
            });

            let html = '';
            validSessions.forEach(session => {
                console.log('Processing session:', session.id, session.title, session.status); // Debug log
                
                const scheduledDate = session.scheduledDateTime ? new Date(session.scheduledDateTime) : null;
                const now = new Date();
                const isUpcoming = scheduledDate && scheduledDate > now;
                const isOngoing = session.status === 'ONGOING';
                const isCompleted = session.status === 'COMPLETED';
                const isScheduled = session.status === 'SCHEDULED';
                
                const cardClass = isOngoing ? 'ongoing' : (isCompleted ? 'completed' : 'scheduled');
                const statusBadge = isOngoing ? '<span class="badge bg-success">ONGOING</span>' : 
                                   (isCompleted ? '<span class="badge bg-secondary">COMPLETED</span>' : 
                                   '<span class="badge bg-primary">SCHEDULED</span>');
                
                html += `
                    <div class="session-card ${cardClass}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h5>${escapeHtml(session.title || 'Untitled Session')} ${statusBadge}</h5>
                                <p class="text-muted">${escapeHtml(session.description || '')}</p>
                                <div class="mt-2">
                                    <p class="mb-1">
                                        ${scheduledDate ? `<strong>Scheduled:</strong> ${scheduledDate.toLocaleString()}<br>` : ''}
                                        <strong>Duration:</strong> ${session.durationMinutes || 'N/A'} minutes<br>
                                        ${session.course ? `<strong>Course:</strong> ${escapeHtml(session.course.title || 'N/A')}<br>` : '<strong>Type:</strong> Standalone Session<br>'}
                                        <strong>Meeting ID:</strong> <code>${escapeHtml(session.meetingId || 'N/A')}</code>
                                    </p>
                                    ${session.meetingLink ? `
                                        <a href="${session.meetingLink}" target="_blank" class="btn btn-sm btn-primary me-2">
                                            <i class="bi bi-camera-video"></i> Join Meeting
                                        </a>
                                        <a href="/ui/lms/live/${session.id}" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-box-arrow-in-right"></i> Open in LMS
                                        </a>
                                    ` : ''}
                                </div>
                            </div>
                            <div>
                                ${isOngoing ? `
                                    <button class="btn btn-sm btn-danger" onclick="endSession(${session.id})">
                                        <i class="bi bi-stop-circle"></i> End Session
                                    </button>
                                ` : isScheduled ? `
                                    <button class="btn btn-sm btn-success" onclick="startSession(${session.id})">
                                        <i class="bi bi-play-circle"></i> Start Session
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('sessionsList').innerHTML = html;
        }

        function showCreateSessionModal() {
            document.getElementById('createSessionForm').reset();
            new bootstrap.Modal(document.getElementById('createSessionModal')).show();
        }

        async function createSession() {
            const form = document.getElementById('createSessionForm');
            const formData = new FormData(form);
            
            const dateTimeValue = formData.get('scheduledDateTime');
            if (!dateTimeValue) {
                alert('Please select a date and time for the session');
                return;
            }
            
            // Convert datetime-local format to ISO format for backend
            // datetime-local format: "2025-11-14T17:00"
            // ISO format needed: "2025-11-14T17:00:00" or "2025-11-14T17:00:00.000Z"
            let isoDateTime = dateTimeValue;
            if (dateTimeValue && !dateTimeValue.includes('Z') && !dateTimeValue.includes('+')) {
                // Add seconds if not present
                if (dateTimeValue.split(':').length === 2) {
                    isoDateTime = dateTimeValue + ':00';
                }
            }
            
            const sessionData = {
                title: formData.get('title'),
                description: formData.get('description'),
                scheduledDateTime: isoDateTime,
                durationMinutes: formData.get('durationMinutes') ? parseInt(formData.get('durationMinutes')) : 60,
                maxParticipants: formData.get('maxParticipants') ? parseInt(formData.get('maxParticipants')) : 50,
                courseId: formData.get('courseId') ? parseInt(formData.get('courseId')) : null
            };

            if (!sessionData.title || !sessionData.scheduledDateTime) {
                alert('Please fill in all required fields');
                return;
            }

            console.log('Creating session with data:', sessionData); // Debug log

            try {
                const response = await fetch('/api/lms/live-sessions', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(sessionData)
                });

                const result = await response.json();
                console.log('Create session response:', result); // Debug log
                
                if (response.ok) {
                    alert('Live session created successfully!\nMeeting Link: ' + result.meetingLink);
                    bootstrap.Modal.getInstance(document.getElementById('createSessionModal')).hide();
                    form.reset();
                    // Reload sessions after a short delay to ensure data is saved
                    setTimeout(() => {
                        loadSessions();
                    }, 500);
                } else {
                    alert('Error: ' + (result.error || 'Failed to create live session'));
                }
            } catch (error) {
                console.error('Error creating live session:', error);
                alert('Failed to create live session: ' + error.message);
            }
        }

        async function startSession(sessionId) {
            try {
                const response = await fetch(`/api/lms/live-sessions/${sessionId}/start`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('Session started!');
                    loadSessions();
                } else {
                    alert('Error: ' + (result.error || 'Failed to start session'));
                }
            } catch (error) {
                console.error('Error starting session:', error);
                alert('Failed to start session');
            }
        }

        async function endSession(sessionId) {
            if (!confirm('Are you sure you want to end this session?')) {
                return;
            }

            try {
                const response = await fetch(`/api/lms/live-sessions/${sessionId}/end`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('Session ended!');
                    loadSessions();
                } else {
                    alert('Error: ' + (result.error || 'Failed to end session'));
                }
            } catch (error) {
                console.error('Error ending session:', error);
                alert('Failed to end session');
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('token');
                window.location.href = '/ui/lms';
            }
        }

        loadCourses();
        loadSessions();
    </script>
</body>
</html>

