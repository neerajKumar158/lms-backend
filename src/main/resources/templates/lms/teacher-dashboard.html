<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard - LMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="/ui/lms">
                <img src="/static/logo.svg" alt="LMS Logo" class="me-2" style="height: 40px; width: auto;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
                <span style="display: none; font-size: 1.5rem; font-weight: bold;">üìö</span>
                <span class="ms-2">LMS Portal</span>
            </a>
            <div class="navbar-nav ms-auto d-flex flex-row align-items-center">
                <a class="nav-link me-3" href="/ui/lms">Home</a>
                <a class="nav-link me-3" id="adminAnalyticsLink" href="/ui/lms/admin/analytics" style="display: none;">Analytics</a>
                <a class="nav-link me-3" id="adminCouponsLink" href="/ui/lms/admin/coupons" style="display: none;">Coupons</a>
                <a class="nav-link me-3" href="#" onclick="logout(); return false;">Logout</a>
                
                <!-- Profile Button -->
                <a class="btn btn-link text-white me-3" href="/ui/lms/profile" style="text-decoration: none;" title="Profile">
                    <i class="bi bi-person-circle fs-5"></i>
                </a>
                
                <!-- Notification Bell Icon - Last Item -->
                <div class="dropdown">
                    <button class="btn btn-link text-white position-relative" type="button" id="notificationDropdown" data-bs-toggle="dropdown" aria-expanded="false" style="text-decoration: none;">
                        <i class="bi bi-bell fs-5"></i>
                        <span id="notificationBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">0</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" id="notificationDropdownMenu" style="min-width: 350px; max-width: 400px; max-height: 500px; overflow-y: auto;">
                        <li><h6 class="dropdown-header">Notifications</h6></li>
                        <li><hr class="dropdown-divider"></li>
                        <li id="notificationListItems">
                            <div class="text-center p-3">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-center" href="/ui/lms/notifications">View All Notifications</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <h1 class="mb-4">Teacher Dashboard</h1>
        
        <div class="row mb-4">
            <div class="col-md-12">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createCourseModal">
                    Create New Course
                </button>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <h3>My Courses</h3>
                <div id="myCoursesList" class="list-group mb-4">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>

                <h3 class="mt-4">Student Report Cards</h3>
                <div class="card mb-3">
                    <div class="card-body">
                        <p class="text-muted">Select a course to view student report cards:</p>
                        <select id="courseSelect" class="form-select mb-3" onchange="loadCourseReportCards()">
                            <option value="">-- Select Course --</option>
                        </select>
                        <div id="reportCardsList">
                            <div class="alert alert-info">Please select a course to view student report cards.</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Quick Actions</h5>
                        <button class="btn btn-primary w-100 mb-2" data-bs-toggle="modal" data-bs-target="#createSessionModal">
                            Schedule Live Session
                        </button>
                        <a href="/ui/lms/assignment/manage" class="btn btn-success w-100 mb-2">
                            <i class="bi bi-file-earmark-check"></i> Manage & Grade Assignments
                        </a>
                        <a href="/ui/lms" class="btn btn-secondary w-100">Back to Home</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Live Session Modal -->
    <div class="modal fade" id="createSessionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Schedule Live Session</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createSessionForm">
                        <div class="mb-3">
                            <label class="form-label">Course (Optional)</label>
                            <select class="form-select" id="sessionCourseSelect" name="courseId">
                                <option value="">-- Standalone Session (No Course) --</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Session Title *</label>
                            <input type="text" class="form-control" name="title" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Scheduled Date & Time *</label>
                                <input type="datetime-local" class="form-control" name="scheduledDateTime" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Duration (minutes)</label>
                                <input type="number" class="form-control" name="durationMinutes" min="15" value="60">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Max Participants</label>
                            <input type="number" class="form-control" name="maxParticipants" min="2" value="50">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createLiveSession()">Create Session</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Course Modal -->
    <div class="modal fade" id="createCourseModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Course</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createCourseForm">
                        <div class="mb-3">
                            <label class="form-label">Course Title</label>
                            <input type="text" class="form-control" name="title" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Price (‚Çπ)</label>
                            <input type="number" class="form-control" name="price" step="0.01" value="0" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Level</label>
                            <select class="form-select" name="level">
                                <option value="BEGINNER">Beginner</option>
                                <option value="INTERMEDIATE">Intermediate</option>
                                <option value="ADVANCED">Advanced</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createCourse()">Create Course</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const token = localStorage.getItem('token');
        
        async function loadMyCourses() {
            if (!token) {
                window.location.href = '/ui/auth';
                return;
            }

            try {
                // Get user info first, then load courses
                const userResponse = await fetch('/api/profile', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                if (!userResponse.ok) {
                    throw new Error('Not authenticated');
                }
                
                const user = await userResponse.json();
                // Use instructor endpoint with user ID
                const response = await fetch(`/api/lms/courses/instructor/${user.id}`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load courses');
                }
                
                const courses = await response.json();
                displayCourses(courses);
            } catch (error) {
                console.error('Error loading courses:', error);
                document.getElementById('myCoursesList').innerHTML = 
                    '<div class="alert alert-danger">Failed to load courses. Please login.</div>';
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function displayCourses(courses) {
            const list = document.getElementById('myCoursesList');
            const courseSelect = document.getElementById('courseSelect');
            const sessionCourseSelect = document.getElementById('sessionCourseSelect');
            
            if (!courses || courses.length === 0) {
                list.innerHTML = '<div class="alert alert-info">You haven\'t created any courses yet. Click "Create New Course" to get started!</div>';
                courseSelect.innerHTML = '<option value="">-- No courses available --</option>';
                if (sessionCourseSelect) {
                    sessionCourseSelect.innerHTML = '<option value="">-- No courses available --</option>';
                }
                return;
            }
            
            // Populate course select dropdown
            const courseOptions = '<option value="">-- Select Course --</option>' + 
                courses.map(course => `<option value="${course.id}">${escapeHtml(course.title || 'Untitled Course')}</option>`).join('');
            courseSelect.innerHTML = courseOptions;
            if (sessionCourseSelect) {
                sessionCourseSelect.innerHTML = '<option value="">-- Standalone Session (No Course) --</option>' + 
                    courses.map(course => `<option value="${course.id}">${escapeHtml(course.title || 'Untitled Course')}</option>`).join('');
            }
            
            list.innerHTML = courses.map(course => {
                const status = course.status || 'DRAFT';
                const statusBadge = status === 'PUBLISHED' ? 
                    '<span class="badge bg-success">Published</span>' : 
                    '<span class="badge bg-secondary">Draft</span>';
                const price = course.price || 0;
                const isFree = price === 0 || price === '0.00' || parseFloat(price) === 0;
                
                return `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h5>${escapeHtml(course.title || 'Untitled Course')} ${statusBadge}</h5>
                                <p class="text-muted">${escapeHtml(course.description ? course.description.substring(0, 150) + '...' : 'No description')}</p>
                                <div class="mt-2">
                                    <span class="badge bg-info me-2">${escapeHtml(course.level || 'BEGINNER')}</span>
                                    <span class="${isFree ? 'text-success' : 'text-primary'} fw-bold">
                                        ${isFree ? 'FREE' : '‚Çπ' + price}
                                    </span>
                                    ${course.featured ? '<span class="badge bg-warning text-dark ms-2">‚≠ê Featured</span>' : ''}
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <a href="/ui/lms/course/manage?id=${course.id}" class="btn btn-sm btn-primary">Manage Course</a>
                            <a href="/ui/lms/courses/${course.id}" class="btn btn-sm btn-outline-primary">View Course</a>
                            <a href="/ui/lms/live-sessions/manage?courseId=${course.id}" class="btn btn-sm btn-info">Live Sessions</a>
                            ${status === 'DRAFT' ? 
                                `<button class="btn btn-sm btn-success" onclick="publishCourse(${course.id})">Publish Course</button>` : 
                                `<button class="btn btn-sm btn-secondary" onclick="unpublishCourse(${course.id})">Unpublish</button>`}
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteCourse(${course.id})">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function unpublishCourse(courseId) {
            if (!confirm('Are you sure you want to unpublish this course? It will no longer be visible to students.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/lms/courses/${courseId}/unpublish`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('Course unpublished successfully!');
                    loadMyCourses();
                } else {
                    alert('Error: ' + (result.error || 'Failed to unpublish course'));
                }
            } catch (error) {
                console.error('Error unpublishing course:', error);
                alert('Failed to unpublish course');
            }
        }
        
        async function deleteCourse(courseId) {
            if (!confirm('Are you sure you want to delete this course? This action cannot be undone and will delete all lectures, materials, assignments, and quizzes.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/lms/courses/${courseId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('Course deleted successfully!');
                    loadMyCourses();
                } else {
                    alert('Error: ' + (result.error || 'Failed to delete course'));
                }
            } catch (error) {
                console.error('Error deleting course:', error);
                alert('Failed to delete course');
            }
        }

        async function createCourse() {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Please login first');
                window.location.href = '/ui/auth';
                return;
            }

            const form = document.getElementById('createCourseForm');
            const formData = new FormData(form);
            
            const courseData = {
                title: formData.get('title'),
                description: formData.get('description'),
                price: formData.get('price'),
                level: formData.get('level'),
                thumbnailUrl: '',
                categoryId: null
            };

            // Validate required fields
            if (!courseData.title || !courseData.description || !courseData.price) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                console.log('Creating course with token:', token ? 'Token present' : 'No token');
                const response = await fetch('/api/lms/courses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify(courseData)
                });

                const responseText = await response.text();
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    result = { error: responseText || 'Unknown error' };
                }
                
                if (response.ok) {
                    alert('Course created successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('createCourseModal')).hide();
                    form.reset();
                    loadMyCourses();
                } else {
                    const errorMsg = result.error || 'Failed to create course';
                    console.error('Error creating course:', errorMsg);
                    if (response.status === 401) {
                        alert('Session expired. Please login again.');
                        localStorage.removeItem('token');
                        window.location.href = '/ui/auth';
                    } else {
                        alert('Error: ' + errorMsg);
                    }
                }
            } catch (error) {
                console.error('Error creating course:', error);
                alert('Failed to create course: ' + error.message);
            }
        }

        async function publishCourse(courseId) {
            if (!confirm('Are you sure you want to publish this course?')) {
                return;
            }

            try {
                const response = await fetch(`/api/lms/courses/${courseId}/publish`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('Course published successfully!');
                    loadMyCourses();
                } else {
                    alert('Error: ' + (result.error || 'Failed to publish course'));
                }
            } catch (error) {
                console.error('Error publishing course:', error);
                alert('Failed to publish course');
            }
        }

        async function loadCourseReportCards() {
            const courseId = document.getElementById('courseSelect').value;
            const reportCardsList = document.getElementById('reportCardsList');
            
            if (!courseId) {
                reportCardsList.innerHTML = '<div class="alert alert-info">Please select a course to view student report cards.</div>';
                return;
            }

            if (!token) {
                window.location.href = '/ui/auth';
                return;
            }

            try {
                reportCardsList.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
                
                const response = await fetch(`/api/lms/report-card/course/${courseId}/students`, {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load report cards');
                }
                
                const reportCards = await response.json();
                displayReportCards(reportCards);
            } catch (error) {
                console.error('Error loading report cards:', error);
                reportCardsList.innerHTML = 
                    '<div class="alert alert-danger">Failed to load report cards. Please try again.</div>';
            }
        }

        function displayReportCards(reportCards) {
            const reportCardsList = document.getElementById('reportCardsList');
            
            if (!reportCards || reportCards.length === 0) {
                reportCardsList.innerHTML = '<div class="alert alert-info">No students enrolled in this course yet.</div>';
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-striped"><thead><tr>' +
                '<th>Student Name</th><th>Overall Score</th><th>Grade</th><th>Quizzes</th><th>Assignments</th><th>Actions</th>' +
                '</tr></thead><tbody>';

            reportCards.forEach(reportCard => {
                const studentName = reportCard.studentName || reportCard.studentEmail || 'Unknown';
                const overallScore = reportCard.overallScore || 0;
                const letterGrade = reportCard.letterGrade || 'N/A';
                const quizzesCompleted = reportCard.quizzesCompleted || 0;
                const totalQuizzes = reportCard.totalQuizzes || 0;
                const assignmentsCompleted = reportCard.assignmentsCompleted || 0;
                const totalAssignments = reportCard.totalAssignments || 0;

                html += `
                    <tr>
                        <td>${escapeHtml(studentName)}</td>
                        <td><strong>${overallScore.toFixed(2)}%</strong></td>
                        <td><span class="badge bg-success">${letterGrade}</span></td>
                        <td>${quizzesCompleted}/${totalQuizzes}</td>
                        <td>${assignmentsCompleted}/${totalAssignments}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewStudentDetails(${reportCard.studentId}, ${reportCard.courseId})">
                                View Details
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            reportCardsList.innerHTML = html;
        }

        function viewStudentDetails(studentId, courseId) {
            window.location.href = `/ui/lms/report-card/detail?courseId=${courseId}&studentId=${studentId}`;
        }

        async function createLiveSession() {
            const form = document.getElementById('createSessionForm');
            const formData = new FormData(form);
            
            const dateTimeValue = formData.get('scheduledDateTime');
            if (!dateTimeValue) {
                alert('Please select a date and time for the session');
                return;
            }
            
            // Convert datetime-local format to ISO format for backend
            let isoDateTime = dateTimeValue;
            if (dateTimeValue && !dateTimeValue.includes('Z') && !dateTimeValue.includes('+')) {
                // Add seconds if not present
                if (dateTimeValue.split(':').length === 2) {
                    isoDateTime = dateTimeValue + ':00';
                }
            }
            
            const sessionData = {
                title: formData.get('title'),
                description: formData.get('description'),
                scheduledDateTime: isoDateTime,
                durationMinutes: formData.get('durationMinutes') ? parseInt(formData.get('durationMinutes')) : 60,
                maxParticipants: formData.get('maxParticipants') ? parseInt(formData.get('maxParticipants')) : 50,
                courseId: formData.get('courseId') ? parseInt(formData.get('courseId')) : null
            };

            if (!sessionData.title || !sessionData.scheduledDateTime) {
                alert('Please fill in all required fields');
                return;
            }

            console.log('Creating session with data:', sessionData); // Debug log

            try {
                const response = await fetch('/api/lms/live-sessions', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(sessionData)
                });

                const result = await response.json();
                console.log('Create session response:', result); // Debug log
                
                if (response.ok) {
                    alert('Live session created successfully! Meeting link: ' + result.meetingLink);
                    bootstrap.Modal.getInstance(document.getElementById('createSessionModal')).hide();
                    form.reset();
                    // Redirect to sessions management page to see the created session
                    window.location.href = '/ui/lms/live-sessions/manage';
                } else {
                    alert('Error: ' + (result.error || 'Failed to create live session'));
                }
            } catch (error) {
                console.error('Error creating live session:', error);
                alert('Failed to create live session: ' + error.message);
            }
        }

        async function updateNotificationBadge() {
            if (!token) return;

            try {
                const response = await fetch('/api/lms/notifications/unread/count', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (response.ok) {
                    const data = await response.json();
                    const badge = document.getElementById('notificationBadge');
                    if (data.count > 0) {
                        badge.textContent = data.count;
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error loading notification count:', error);
            }
        }

        // Check user role and redirect if not teacher
        async function checkTeacherAccess() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/ui/auth';
                return;
            }

            try {
                const response = await fetch('/api/profile', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (response.ok) {
                    const user = await response.json();
                    const userType = user.userType || user.user_type;
                    
                    // Show admin links if user is admin
                    if (userType === 'ADMIN') {
                        document.getElementById('adminAnalyticsLink').style.display = 'block';
                        document.getElementById('adminCouponsLink').style.display = 'block';
                    }
                    
                    if (userType !== 'TEACHER' && userType !== 'ADMIN') {
                        alert('Access denied. This page is only for teachers.');
                        window.location.href = '/ui/lms';
                        return;
                    }
                } else {
                    window.location.href = '/ui/auth';
                    return;
                }
            } catch (error) {
                console.error('Error checking access:', error);
                window.location.href = '/ui/auth';
                return;
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('token');
                window.location.href = '/ui/lms';
            }
        }

        // Notification functions
        async function loadNotificationDropdown() {
            const token = localStorage.getItem('token');
            if (!token) return;

            try {
                const response = await fetch('/api/lms/notifications/unread', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (response.ok) {
                    const notifications = await response.json();
                    displayNotificationDropdown(notifications.slice(0, 5)); // Show only 5 most recent
                    updateNotificationBadge(notifications.length);
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        function displayNotificationDropdown(notifications) {
            const container = document.getElementById('notificationListItems');
            if (!container) return;

            if (notifications.length === 0) {
                container.innerHTML = '<div class="text-center p-3 text-muted">No new notifications</div>';
                return;
            }

            container.innerHTML = notifications.map(notif => {
                const icon = getNotificationIcon(notif.type);
                const date = new Date(notif.createdAt).toLocaleString();
                return `
                    <li>
                        <a class="dropdown-item" href="#" onclick="handleNotificationClick(${notif.id}, '${notif.actionUrl || ''}'); return false;">
                            <div class="d-flex align-items-start">
                                <i class="bi ${icon} me-2 mt-1"></i>
                                <div class="flex-grow-1">
                                    <div class="fw-bold small">${escapeHtml(notif.title || 'Notification')}</div>
                                    <div class="text-muted small">${escapeHtml(notif.message || '').substring(0, 50)}${notif.message && notif.message.length > 50 ? '...' : ''}</div>
                                    <div class="text-muted" style="font-size: 0.75rem;">${date}</div>
                                </div>
                            </div>
                        </a>
                    </li>
                `;
            }).join('');
        }

        function getNotificationIcon(type) {
            const icons = {
                'INFO': 'bi-info-circle',
                'SUCCESS': 'bi-check-circle',
                'WARNING': 'bi-exclamation-triangle',
                'ERROR': 'bi-x-circle',
                'ASSIGNMENT': 'bi-file-earmark-text',
                'QUIZ': 'bi-question-circle',
                'ANNOUNCEMENT': 'bi-megaphone',
                'CERTIFICATE': 'bi-award'
            };
            return icons[type] || 'bi-bell';
        }

        async function handleNotificationClick(notificationId, actionUrl) {
            const token = localStorage.getItem('token');
            // Mark as read
            try {
                await fetch(`/api/lms/notifications/${notificationId}/read`, {
                    method: 'PATCH',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
            } catch (err) {
                console.error('Error marking as read:', err);
            }

            // Close dropdown
            const dropdown = bootstrap.Dropdown.getInstance(document.getElementById('notificationDropdown'));
            if (dropdown) dropdown.hide();

            // Navigate if action URL is provided
            if (actionUrl && actionUrl.trim() !== '') {
                window.location.href = actionUrl;
            } else {
                // Reload notifications
                loadNotificationDropdown();
            }
        }

        async function updateNotificationBadge(count) {
            const badge = document.getElementById('notificationBadge');
            if (!badge) return;

            if (count === undefined) {
                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch('/api/lms/notifications/unread/count', {
                        headers: { 'Authorization': 'Bearer ' + token }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        count = data.count || 0;
                    }
                } catch (error) {
                    console.error('Error updating badge:', error);
                    return;
                }
            }

            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Load notifications when dropdown is opened
        document.addEventListener('DOMContentLoaded', function() {
            const dropdown = document.getElementById('notificationDropdown');
            if (dropdown) {
                dropdown.addEventListener('show.bs.dropdown', function() {
                    loadNotificationDropdown();
                });
            }
        });

        // Check access before loading data
        checkTeacherAccess().then(() => {
            loadMyCourses();
            updateNotificationBadge();
            setInterval(() => {
                updateNotificationBadge();
                loadNotificationDropdown();
            }, 30000); // Update every 30 seconds
        });
    </script>
</body>
</html>

