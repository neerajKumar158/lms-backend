<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Session - LMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #jitsi-container {
            width: 100%;
            height: 600px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="/ui/lms">
                <img src="/static/logo.svg" alt="LMS Logo" class="me-2" style="height: 40px; width: auto;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
                <span style="display: none; font-size: 1.5rem; font-weight: bold;">ðŸ“š</span>
                <span class="ms-2">LMS Portal</span>
            </a>
            <div class="navbar-nav ms-auto d-flex flex-row">
                <a class="nav-link me-3" href="/ui/lms">Home</a>
                <a class="nav-link" href="#" onclick="logout(); return false;">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <h2 id="sessionTitle">Loading Session...</h2>
        <div id="sessionInfo" class="mb-3"></div>
        
        <div id="jitsi-container"></div>
        
        <div class="mt-3">
            <button class="btn btn-secondary" onclick="window.location.href='/ui/lms'">Back to Home</button>
            <button id="endSessionBtn" class="btn btn-danger" onclick="endSession()" style="display: none;">
                End Session (Instructor Only)
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://8x8.vc/external_api.js"></script>
    <script>
        const token = localStorage.getItem('token');
        // Get sessionId from URL or Thymeleaf
        function getSessionIdFromUrl() {
            const path = window.location.pathname;
            const match = path.match(/\/live\/(\d+)/);
            if (match) {
                return parseInt(match[1]);
            }
            return null;
        }
        
        const sessionId = /*[[${sessionId}]]*/ getSessionIdFromUrl();
        let api = null;
        let sessionData = null;
        let isInstructorFlag = false;

        console.log('Session ID:', sessionId); // Debug log

        if (!token) {
            window.location.href = '/ui/auth';
        }

        async function loadSession() {
            const currentSessionId = sessionId || getSessionIdFromUrl();
            
            if (!currentSessionId) {
                document.getElementById('sessionTitle').textContent = 'Session not found';
                document.getElementById('sessionInfo').innerHTML = 
                    '<div class="alert alert-danger">Session ID is required. Please check the URL.</div>';
                return;
            }
            
            console.log('Loading session with ID:', currentSessionId);

            try {
                const response = await fetch(`/api/lms/live-sessions/${currentSessionId}`, {
                    headers: token ? { 'Authorization': 'Bearer ' + token } : {}
                });
                
                console.log('API Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error:', errorText);
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch (e) {
                        errorData = { error: errorText || 'Session not found' };
                    }
                    throw new Error(errorData.error || 'Session not found');
                }
                
                sessionData = await response.json();
                
                // Check if user is instructor
                if (token) {
                    try {
                        const userResponse = await fetch('/api/profile', {
                            headers: { 'Authorization': 'Bearer ' + token }
                        });
                        if (userResponse.ok) {
                            const user = await userResponse.json();
                            isInstructorFlag = sessionData.instructor && sessionData.instructor.id === user.id;
                            if (isInstructorFlag) {
                                document.getElementById('endSessionBtn').style.display = 'block';
                            }
                        }
                    } catch (e) {
                        console.error('Error checking instructor status:', e);
                    }
                }
                
                document.getElementById('sessionTitle').textContent = sessionData.title || 'Live Session';
                document.getElementById('sessionInfo').innerHTML = `
                    <div class="card">
                        <div class="card-body">
                            <p><strong>Description:</strong> ${escapeHtml(sessionData.description || 'N/A')}</p>
                            <p><strong>Scheduled:</strong> ${new Date(sessionData.scheduledDateTime).toLocaleString()}</p>
                            <p><strong>Duration:</strong> ${sessionData.durationMinutes || 'N/A'} minutes</p>
                            ${sessionData.course ? `<p><strong>Course:</strong> ${escapeHtml(sessionData.course.title || 'N/A')}</p>` : ''}
                            ${sessionData.meetingLink ? `<p><strong>Meeting Link:</strong> <a href="${sessionData.meetingLink}" target="_blank">${sessionData.meetingLink}</a></p>` : ''}
                        </div>
                    </div>
                `;

                // Initialize Jitsi Meet
                if (sessionData.meetingLink && sessionData.meetingId) {
                    // Wait a bit for Jitsi script to load
                    if (typeof JitsiMeetExternalAPI === 'undefined') {
                        console.warn('Jitsi script not loaded yet, waiting...');
                        setTimeout(() => {
                            if (typeof JitsiMeetExternalAPI !== 'undefined') {
                                initializeJitsi();
                            } else {
                                document.getElementById('jitsi-container').innerHTML = 
                                    '<div class="alert alert-danger">Failed to load video conference. Please refresh the page.</div>';
                            }
                        }, 1000);
                    } else {
                        initializeJitsi();
                    }
                } else {
                    document.getElementById('jitsi-container').innerHTML = 
                        '<div class="alert alert-warning">Meeting link not available. Please contact the instructor.</div>';
                }
            } catch (error) {
                console.error('Error loading session:', error);
                document.getElementById('sessionTitle').textContent = 'Error loading session';
                document.getElementById('sessionInfo').innerHTML = 
                    '<div class="alert alert-danger">Failed to load session: ' + escapeHtml(error.message || 'Unknown error') + '</div>';
            }
        }

        async function initializeJitsi() {
            if (!sessionData || !sessionData.meetingId) {
                return;
            }

            try {
                // Get user info
                let userName = 'Participant';
                let userEmail = '';
                
                if (token) {
                    try {
                        const userResponse = await fetch('/api/profile', {
                            headers: { 'Authorization': 'Bearer ' + token }
                        });
                        if (userResponse.ok) {
                            const user = await userResponse.json();
                            userName = user.name || user.email || 'Participant';
                            userEmail = user.email || '';
                        }
                    } catch (e) {
                        console.error('Error fetching user info:', e);
                    }
                }

                const domain = 'meet.jit.si';
                const options = {
                    roomName: sessionData.meetingId,
                    width: '100%',
                    height: 600,
                    parentNode: document.querySelector('#jitsi-container'),
                    configOverwrite: {
                        startWithAudioMuted: false,
                        startWithVideoMuted: false,
                        enableWelcomePage: true,
                        enableClosePage: false,
                        prejoinPageEnabled: true
                    },
                    interfaceConfigOverwrite: {
                        TOOLBAR_BUTTONS: [
                            'microphone', 'camera', 'closedcaptions', 'desktop', 'fullscreen',
                            'fodeviceselection', 'hangup', 'profile', 'chat', 'settings',
                            'raisehand', 'videoquality', 'filmstrip', 'invite', 'feedback',
                            'stats', 'shortcuts', 'tileview', 'download', 'help', 'mute-everyone'
                        ],
                        SETTINGS_SECTIONS: ['devices', 'language', 'moderator', 'profile'],
                        DEFAULT_BACKGROUND: '#667eea'
                    },
                    userInfo: {
                        displayName: userName,
                        email: userEmail
                    }
                };

                api = new JitsiMeetExternalAPI(domain, options);
                
                api.addEventListener('videoConferenceJoined', (event) => {
                    console.log('Joined conference:', event);
                    if (isInstructorFlag && sessionData.status === 'SCHEDULED') {
                        updateSessionStatus('start');
                    }
                });
                
                api.addEventListener('videoConferenceLeft', (event) => {
                    console.log('Left conference:', event);
                    if (isInstructorFlag) {
                        endSession();
                    } else {
                        // Just redirect back
                        setTimeout(() => {
                            window.location.href = sessionData.course ? `/ui/lms/courses/${sessionData.course.id}` : '/ui/lms';
                        }, 2000);
                    }
                });
                
                api.addEventListener('participantJoined', (event) => {
                    console.log('Participant joined:', event);
                });
                
                api.addEventListener('participantLeft', (event) => {
                    console.log('Participant left:', event);
                });
                
                api.addEventListener('readyToClose', () => {
                    if (api) {
                        api.dispose();
                    }
                });
            } catch (error) {
                console.error('Error initializing Jitsi:', error);
                document.getElementById('jitsi-container').innerHTML = 
                    '<div class="alert alert-danger">Failed to initialize video conference. Please try refreshing the page.</div>';
            }
        }

        async function updateSessionStatus(action) {
            if (!token || !isInstructorFlag) return;
            
            const currentSessionId = sessionId || getSessionIdFromUrl();
            if (!currentSessionId) return;
            
            try {
                const endpoint = action === 'start' ? 'start' : 'end';
                const response = await fetch(`/api/lms/live-sessions/${currentSessionId}/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                if (response.ok) {
                    console.log('Session status updated:', action);
                    // Reload session data to get updated status
                    if (action === 'start') {
                        loadSession();
                    }
                } else {
                    const error = await response.json().catch(() => ({ error: 'Failed to update status' }));
                    console.error('Failed to update session status:', error);
                }
            } catch (error) {
                console.error('Error updating session status:', error);
            }
        }

        async function endSession() {
            if (!confirm('Are you sure you want to end this session?')) {
                return;
            }
            
            await updateSessionStatus('end');
            if (api) {
                api.dispose();
            }
            window.location.href = sessionData && sessionData.course ? `/ui/lms/courses/${sessionData.course.id}` : '/ui/lms';
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (api) {
                api.dispose();
            }
        });

        loadSession();
    </script>
</body>
</html>

