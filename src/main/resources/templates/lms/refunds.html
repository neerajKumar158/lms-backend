<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refund Management - LMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="/ui/lms">
                <img src="/static/logo.svg" alt="LMS Logo" class="me-2" style="height: 40px; width: auto;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
                <span style="display: none; font-size: 1.5rem; font-weight: bold;">ðŸ“š</span>
                <span class="ms-2">LMS Portal</span>
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/ui/lms/student/dashboard">Dashboard</a>
                <a class="nav-link active" href="/ui/lms/refunds">My Refunds</a>
                <a class="nav-link" href="#" onclick="logout(); return false;">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <h1 class="mb-4">My Refund Requests</h1>

        <div id="refundsContainer">
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Request Refund Modal -->
    <div class="modal fade" id="requestRefundModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Request Refund</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="refundRequestForm">
                        <input type="hidden" id="refundPaymentId">
                        <div class="mb-3">
                            <label class="form-label">Reason for Refund</label>
                            <textarea class="form-control" id="refundReason" rows="4" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitRefundRequest()">Submit Request</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/ui/auth';
        }

        async function loadRefunds() {
            try {
                const response = await fetch('/api/lms/refunds/my-refunds', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!response.ok) {
                    throw new Error('Failed to load refunds');
                }

                const refunds = await response.json();
                displayRefunds(refunds);
            } catch (error) {
                console.error('Error loading refunds:', error);
                document.getElementById('refundsContainer').innerHTML = 
                    '<div class="alert alert-danger">Failed to load refunds.</div>';
            }
        }

        function displayRefunds(refunds) {
            const container = document.getElementById('refundsContainer');
            
            if (!refunds || refunds.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <h5>No refund requests</h5>
                        <p>You haven't requested any refunds yet.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Course</th>
                                <th>Amount</th>
                                <th>Reason</th>
                                <th>Status</th>
                                <th>Requested Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${refunds.map(refund => `
                                <tr>
                                    <td>${escapeHtml(refund.course?.title || 'Unknown')}</td>
                                    <td>â‚¹${parseFloat(refund.amount || 0).toFixed(2)}</td>
                                    <td>${escapeHtml(refund.reason || 'N/A')}</td>
                                    <td>
                                        <span class="badge bg-${getStatusColor(refund.status)}">
                                            ${escapeHtml(refund.status || 'PENDING')}
                                        </span>
                                    </td>
                                    <td>${new Date(refund.requestedAt).toLocaleDateString()}</td>
                                    <td>
                                        ${refund.adminNotes ? 
                                            `<small class="text-muted">${escapeHtml(refund.adminNotes)}</small>` : 
                                            '-'
                                        }
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function getStatusColor(status) {
            switch(status) {
                case 'APPROVED':
                case 'PROCESSED':
                    return 'success';
                case 'REJECTED':
                case 'FAILED':
                    return 'danger';
                case 'PENDING':
                    return 'warning';
                default:
                    return 'secondary';
            }
        }

        function requestRefund(paymentId) {
            document.getElementById('refundPaymentId').value = paymentId;
            document.getElementById('refundReason').value = '';
            new bootstrap.Modal(document.getElementById('requestRefundModal')).show();
        }

        async function submitRefundRequest() {
            const paymentId = document.getElementById('refundPaymentId').value;
            const reason = document.getElementById('refundReason').value.trim();

            if (!reason) {
                alert('Please provide a reason for the refund');
                return;
            }

            try {
                const response = await fetch(`/api/lms/refunds/request/${paymentId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason: reason })
                });

                const data = await response.json();

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('requestRefundModal')).hide();
                    alert('Refund request submitted successfully');
                    loadRefunds();
                } else {
                    alert(data.error || 'Failed to submit refund request');
                }
            } catch (error) {
                console.error('Error submitting refund request:', error);
                alert('Failed to submit refund request');
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/ui/auth';
        }

        // Load refunds on page load
        loadRefunds();
    </script>
</body>
</html>

