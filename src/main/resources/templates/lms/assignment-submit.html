<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit Assignment - LMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="/ui/lms">
                <img src="/static/logo.svg" alt="LMS Logo" class="me-2" style="height: 40px; width: auto;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
                <span style="display: none; font-size: 1.5rem; font-weight: bold;">ðŸ“š</span>
                <span class="ms-2">LMS Portal</span>
            </a>
            <div class="navbar-nav ms-auto d-flex flex-row">
                <a class="nav-link me-3" href="/ui/lms">Home</a>
                <a class="nav-link" href="#" onclick="logout(); return false;">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <h2 id="assignmentTitle">Loading Assignment...</h2>
        <div id="assignmentInfo" class="mb-4"></div>
        
        <div class="card">
            <div class="card-body">
                <h4 class="card-title">Submit Your Assignment</h4>
                <form id="submitForm">
                    <div class="mb-3">
                        <label class="form-label">Your Answer / Submission Text *</label>
                        <textarea class="form-control" id="submissionText" rows="10" required
                                  placeholder="Enter your assignment submission here..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Upload File (Optional)</label>
                        <input type="file" class="form-control" id="submissionFile" accept=".pdf,.doc,.docx,.txt">
                        <small class="form-text text-muted">Supported formats: PDF, DOC, DOCX, TXT (Max 10MB)</small>
                        <div id="fileStatus" class="mt-2"></div>
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>Due Date:</strong> <span id="dueDate"></span>
                        <div id="lateWarning" class="mt-2 text-warning" style="display: none;">
                            <strong>âš  Late Submission:</strong> This assignment is past its due date.
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="/ui/lms/student/dashboard" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary">Submit Assignment</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const token = localStorage.getItem('token');
        const assignmentId = new URLSearchParams(window.location.search).get('id');
        let assignmentData = null;
        let uploadedFileUrl = null;

        if (!token) {
            window.location.href = '/ui/auth';
        }

        async function loadAssignment() {
            if (!assignmentId) {
                document.getElementById('assignmentTitle').textContent = 'Assignment ID not provided';
                return;
            }

            try {
                const response = await fetch(`/api/lms/assignments/${assignmentId}`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load assignment');
                }
                
                assignmentData = await response.json();
                displayAssignment(assignmentData);
            } catch (error) {
                console.error('Error loading assignment:', error);
                document.getElementById('assignmentTitle').textContent = 'Error loading assignment';
            }
        }

        function displayAssignment(assignment) {
            document.getElementById('assignmentTitle').textContent = assignment.title || 'Assignment';
            
            const dueDate = assignment.dueDate ? new Date(assignment.dueDate) : null;
            const isLate = dueDate && new Date() > dueDate;
            
            document.getElementById('assignmentInfo').innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <h5>Assignment Details</h5>
                        <p><strong>Description:</strong> ${escapeHtml(assignment.description || 'N/A')}</p>
                        <p><strong>Instructions:</strong> ${escapeHtml(assignment.instructions || 'N/A')}</p>
                        <p><strong>Max Score:</strong> ${assignment.maxScore || 'N/A'} points</p>
                        <p><strong>Type:</strong> ${assignment.type || 'N/A'}</p>
                        ${assignment.attachmentUrl ? `<p><a href="${escapeHtml(assignment.attachmentUrl)}" target="_blank">Download Assignment File</a></p>` : ''}
                    </div>
                </div>
            `;
            
            if (dueDate) {
                document.getElementById('dueDate').textContent = dueDate.toLocaleString();
                if (isLate) {
                    document.getElementById('lateWarning').style.display = 'block';
                }
            } else {
                document.getElementById('dueDate').textContent = 'No due date';
            }
        }

        // File upload handler
        document.getElementById('submissionFile').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > 10 * 1024 * 1024) {
                alert('File size exceeds 10MB limit');
                e.target.value = '';
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('type', 'assignment');

            try {
                document.getElementById('fileStatus').innerHTML = '<div class="spinner-border spinner-border-sm"></div> Uploading...';
                
                const response = await fetch('/api/lms/files/upload', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token },
                    body: formData
                });

                const result = await response.json();
                
                if (response.ok) {
                    uploadedFileUrl = result.fileUrl;
                    document.getElementById('fileStatus').innerHTML = 
                        `<div class="alert alert-success">File uploaded successfully: ${escapeHtml(file.name)}</div>`;
                } else {
                    throw new Error(result.error || 'Upload failed');
                }
            } catch (error) {
                console.error('Upload error:', error);
                document.getElementById('fileStatus').innerHTML = 
                    `<div class="alert alert-danger">Upload failed: ${error.message}</div>`;
                uploadedFileUrl = null;
            }
        });

        // Form submission
        document.getElementById('submitForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const submissionText = document.getElementById('submissionText').value;
            if (!submissionText.trim()) {
                alert('Please enter your submission text');
                return;
            }

            try {
                const response = await fetch(`/api/lms/assignments/${assignmentId}/submit`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: submissionText,
                        attachmentUrl: uploadedFileUrl
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('Assignment submitted successfully!');
                    window.location.href = '/ui/lms/student/dashboard';
                } else {
                    alert('Error: ' + (result.error || 'Failed to submit assignment'));
                }
            } catch (error) {
                console.error('Submission error:', error);
                alert('Failed to submit assignment. Please try again.');
            }
        });

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        loadAssignment();
    </script>
</body>
</html>



